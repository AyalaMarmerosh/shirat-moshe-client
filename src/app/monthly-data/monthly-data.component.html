<div style="text-align: center; margin: 20px 0">
  <button mat-raised-button color="primary" (click)="exportToExcel()">
    <mat-icon style="margin-left: 8px">download</mat-icon>
    ייצא לאקסל
  </button>
</div>

<div dir="rtl" class="form-section">
  <mat-form-field appearance="outline" style="flex: 1; min-width: 150px">
    <mat-label>חודש</mat-label>
    <input
      matInput
      type="text"
      [(ngModel)]="selectedMonth"
      (ngModelChange)="getRecords()"
      placeholder="לדוגמה: חשוון"
    />
  </mat-form-field>

  <mat-form-field appearance="outline" style="flex: 1; min-width: 150px">
    <mat-label>שנה</mat-label>
    <input
      matInput
      type="text"
      [(ngModel)]="selectedYear"
      (ngModelChange)="getRecords()"
      placeholder="לדוגמה: תשפ"
    />
  </mat-form-field>

  <mat-form-field appearance="outline" style="flex: 1; min-width: 150px">
    <mat-label>שם</mat-label>
    <input
      matInput
      type="text"
      [(ngModel)]="searchName"
      (ngModelChange)="getRecords()"
      placeholder="חפש לפי שם"
    />
  </mat-form-field>

  <button
    mat-icon-button
    matTooltip="הוספת נתונים עבור אברך בודד"
    matTooltipPosition="above"
    (click)="openPopup()"
    style="margin: 0 10px"
  >
    <mat-icon>add_circle</mat-icon>
  </button>
</div>

<div class="scrollable-container" dir="rtl">
  <mat-card class="scrollable-table">
    <mat-table [dataSource]="records" class="mat-elevation-z3">
      <!-- Edit Column -->
      <ng-container matColumnDef="edit">
        <mat-header-cell
          *matHeaderCellDef
          style="width: 120px; min-width: 120px; flex: 0 0 120px"
        ></mat-header-cell>
        <mat-cell
          *matCellDef="let record; let i = index"
          style="
            width: 120px;
            min-width: 120px;
            flex: 0 0 120px;
            display: flex;
            gap: 5px;
            justify-content: center;
          "
        >
          <ng-container *ngIf="!isEditing(i)">
            <button
              mat-icon-button
              (click)="deleteData(record.id)"
              matTooltip="מחק"
              matTooltipPosition="above"
              style="min-width: 40px; background: transparent; padding: 0"
            >
              <mat-icon class="delete-icon" style="font-size: 20px"
                >delete_outline</mat-icon
              >
            </button>
            <button
              mat-icon-button
              (click)="editRow(i)"
              matTooltip="ערוך"
              matTooltipPosition="above"
              style="min-width: 40px; background: transparent; padding: 0"
            >
              <mat-icon class="clickable-icon" style="font-size: 20px"
                >edit_note</mat-icon
              >
            </button>
          </ng-container>
          <ng-container *ngIf="isEditing(i)">
            <mat-icon
              class="clickable-icon"
              (click)="saveRow(record)"
              matTooltip="שמור"
              matTooltipPosition="above"
              style="
                cursor: pointer;
                min-width: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
              "
              >save</mat-icon
            >
            <mat-icon
              class="clickable-icon"
              (click)="cancelEdit()"
              matTooltip="בטל"
              matTooltipPosition="above"
              style="
                cursor: pointer;
                min-width: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 20px;
              "
              >cancel</mat-icon
            >
          </ng-container>
        </mat-cell>
        <mat-footer-cell
          *matFooterCellDef
          style="width: 120px; min-width: 120px; flex: 0 0 120px"
        ></mat-footer-cell>
      </ng-container>

      <!-- Index Column -->
      <ng-container matColumnDef="index">
        <mat-header-cell *matHeaderCellDef style="flex: 0.6"
          >מס'</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 0.6">{{
          i + 1
        }}</mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 0.6"></mat-footer-cell>
      </ng-container>

      <!-- Name Column -->
      <ng-container matColumnDef="id">
        <mat-header-cell *matHeaderCellDef style="flex: 1.2"
          >שם</mat-header-cell
        >
        <mat-cell
          *matCellDef="let record"
          (click)="onAbrekClick(record.personId)"
          style="flex: 1.2; cursor: pointer; color: #0284c7; font-weight: 500"
        >
          {{ getAvrechName(record.personId) }}
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 1.2"></mat-footer-cell>
      </ng-container>

      <!-- Month Column -->
      <ng-container matColumnDef="month">
        <mat-header-cell *matHeaderCellDef style="flex: 0.9"
          >חודש</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 0.9">
          <ng-container *ngIf="!isEditing(i)">{{ record.month }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <input
              matInput
              [(ngModel)]="record.month"
              (ngModelChange)="
                calculateTotalAmount(record);
                calculateOrElchanan(record);
                calculateAdd(record)
              "
            />
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 0.9"></mat-footer-cell>
      </ng-container>

      <!-- Year Column -->
      <ng-container matColumnDef="year">
        <mat-header-cell *matHeaderCellDef style="flex: 0.9"
          >שנה</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 0.9">
          <ng-container *ngIf="!isEditing(i)">{{ record.year }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <input
              matInput
              [(ngModel)]="record.year"
              (ngModelChange)="
                calculateTotalAmount(record);
                calculateOrElchanan(record);
                calculateAdd(record)
              "
            />
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 0.9"></mat-footer-cell>
      </ng-container>

      <!-- Base Allowance Column -->
      <ng-container matColumnDef="baseAllowance">
        <mat-header-cell *matHeaderCellDef style="flex: 1"
          >מלגת בסיס</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 1">
          <ng-container *ngIf="!isEditing(i)">{{
            record.baseAllowance
          }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <input
              matInput
              type="number"
              [(ngModel)]="record.baseAllowance"
              (ngModelChange)="
                calculateTotalAmount(record);
                calculateOrElchanan(record);
                calculateAdd(record)
              "
            />
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 1"></mat-footer-cell>
      </ng-container>

      <!-- Chabura Column -->
      <ng-container matColumnDef="isChabura">
        <mat-header-cell *matHeaderCellDef style="flex: 0.8"
          >חבורה</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 0.8">
          <ng-container *ngIf="!isEditing(i)">{{
            record.isChabura ? "300" : ""
          }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <mat-checkbox
              [(ngModel)]="record.isChabura"
              (ngModelChange)="
                calculateTotalAmount(record);
                calculateOrElchanan(record);
                calculateAdd(record)
              "
            ></mat-checkbox>
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 0.8"></mat-footer-cell>
      </ng-container>

      <!-- Test Column -->
      <ng-container matColumnDef="didLargeTest">
        <mat-header-cell *matHeaderCellDef style="flex: 0.8"
          >מבחן</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 0.8">
          <ng-container *ngIf="!isEditing(i)">{{
            record.didLargeTest ? "500" : ""
          }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <mat-checkbox
              [(ngModel)]="record.didLargeTest"
              (ngModelChange)="
                calculateTotalAmount(record);
                calculateOrElchanan(record);
                calculateAdd(record)
              "
            ></mat-checkbox>
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 0.8"></mat-footer-cell>
      </ng-container>

      <!-- Total Amount Column -->
      <ng-container matColumnDef="totalAmount">
        <mat-header-cell *matHeaderCellDef style="flex: 1"
          >סכום סופי</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 1">
          <ng-container *ngIf="!isEditing(i)">{{
            record.totalAmount
          }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <input
              matInput
              type="number"
              [(ngModel)]="record.totalAmount"
              (ngModelChange)="
                calculateOrElchanan(record); calculateAdd(record)
              "
            />
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 1"></mat-footer-cell>
      </ng-container>

      <!-- Datot Column -->
      <ng-container matColumnDef="datot">
        <mat-header-cell *matHeaderCellDef style="flex: 0.9"
          >דתות</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 0.9">
          <ng-container *ngIf="!isEditing(i)">{{ record.datot }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <input
              matInput
              type="number"
              [(ngModel)]="record.datot"
              (ngModelChange)="
                calculateOrElchanan(record); calculateAdd(record)
              "
            />
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 0.9"></mat-footer-cell>
      </ng-container>

      <!-- Or Elchanan Column -->
      <ng-container matColumnDef="orElchanan">
        <mat-header-cell *matHeaderCellDef style="flex: 1"
          >אור אלחנן</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 1">
          <ng-container *ngIf="!isEditing(i)">{{
            record.orElchanan
          }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <input
              matInput
              type="number"
              [(ngModel)]="record.orElchanan"
              (ngModelChange)="calculateAdd(record)"
            />
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 1; color: red;">
           {{ getTotalOrElchanan() }}
        </mat-footer-cell>
      </ng-container>

      <!-- Additional Amount Column -->
      <ng-container matColumnDef="addAmount">
        <mat-header-cell *matHeaderCellDef style="flex: 0.9"
          >יתרה</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 0.9">
          <ng-container *ngIf="!isEditing(i)">{{
            record.addAmount
          }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <input matInput type="number" [(ngModel)]="record.addAmount" />
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 0.9; color: red;"
          > {{ getTotalAddAmount() }}</mat-footer-cell
        >
      </ng-container>

      <!-- Ginusar Column -->
      <ng-container matColumnDef="ginusar">
        <mat-header-cell *matHeaderCellDef style="flex: 1"
          >פירות גינוסר</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 1">
          <ng-container *ngIf="!isEditing(i)">{{
            record.ginusar
          }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <input matInput type="number" [(ngModel)]="record.ginusar" />
          </ng-container>
        </mat-cell>
          <mat-footer-cell *matFooterCellDef style="flex: 1; color: red;">
           {{ getTotalOrGinusar() }}
        </mat-footer-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 1"></mat-footer-cell>
      </ng-container>

      <!-- Notes Column -->
      <ng-container matColumnDef="notes">
        <mat-header-cell *matHeaderCellDef style="flex: 1.2"
          >הערה</mat-header-cell
        >
        <mat-cell *matCellDef="let record; let i = index" style="flex: 1.2">
          <ng-container *ngIf="!isEditing(i)">{{ record.notes }}</ng-container>
          <ng-container *ngIf="isEditing(i)">
            <input matInput [(ngModel)]="record.notes" />
          </ng-container>
        </mat-cell>
        <mat-footer-cell *matFooterCellDef style="flex: 1.2"></mat-footer-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns"></mat-row>
      <mat-footer-row *matFooterRowDef="displayedColumns"></mat-footer-row>
    </mat-table>
  </mat-card>
</div>

<div *ngIf="isLoading" class="text-center">
  <div class="spinner"></div>
  <p>טוען נתונים, אנא המתן...</p>
</div>
